---
title: "Interactive Plots"
author: "Matt Eldridge"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

In this section we briefly introduce creating Shiny applications with interactive plots. These are figures where clicking on a point within a plot will trigger a selection event that causes an update to another part of the application.

We will show how this can be achieved with static plots generated by ggplot2 and also with HighCharts which allows for even more interactivity including zooming and tooltips.

For the examples shown here we use the results of a differential expression analysis using [limma](https://bioconductor.org/packages/release/bioc/html/limma.html), comparing ER negative and positive status groups (see [DE.R](DE.R) script).

### ggplot2

The following Shiny application shows a Volcano plot of the log p-value versus the log fold change.

Here we add a `click` argument to `plotOutput` to listen to mouse click events and update a table with details of the data points near to the cursor. You can also listen to double-click and hover (mouse-over) events in exactly the same way.

Note the way in which the table is updated in response to a mouse click as reflected in a change in the value of `input$volcanoPlotClick`. `nearPoints` is a convenient function for extracting the rows of the data frame on which the plot is based for the points near where the mouse was clicked. In the code below, `nearPoints` is used to provide the data frame with the subset of rows corresponding to the mouse click to the `renderDataTable` function.

```{r message = FALSE}
library(shiny)
library(tidyverse)

differentialExpressionResults <-
  read.csv("NKI-DE-results.csv") %>%
  rename(Gene = HUGO.gene.symbol) %>%
  rename(Probe = probe) %>%
  mutate(logFC = signif(logFC, digits = 2)) %>%
  mutate(adj.P.Val = signif(adj.P.Val, digits = 2)) %>%
  mutate(minusLog10Pvalue = -log10(adj.P.Val))

ui <- fluidPage(
  fluidRow(
    column(
      width = 6,
      plotOutput("volcanoPlot", click = "volcanoPlotSelection")
    ),
    column(
      width = 6,
      dataTableOutput("info")
    )
  )
)

server <- function(input, output) {

  output$volcanoPlot <- renderPlot({
    differentialExpressionResults %>%
      ggplot(aes(x = logFC, y = minusLog10Pvalue)) +
      geom_point() +
      xlab("log fold change") +
      ylab("-log10(P-value)")
  })

  output$info <- renderDataTable(
    nearPoints(differentialExpressionResults, input$volcanoPlotSelection) %>%
      select(Probe, Gene, logFC, adj.P.Val),
    options = list(pageLength = 5, dom = "tip", searching = FALSE)
  )
}

shinyApp(ui, server)
```

Note that if you are using base graphics the `nearPoints` function needs to be provided with details of what columns were used for the x- and y-axes; for ggplot2 Shiny was able to infer these and so we didn't need to specify `xvar` and `yvar` arguments.

#### Exercise

Try changing the code above to handle mouse-over (hover) and brush events (brushing involves drawing a box in the plot area) instead of mouse clicks. *Hint: see help page for `plotOutput` function.*


